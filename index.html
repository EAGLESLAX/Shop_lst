<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ruta sin API - OpenStreetMap</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<style>
  body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f5f7fa; }
  header { background: #2c3e50; color: #fff; padding: 1rem; text-align: center; }
  #map { height: 400px; margin: 20px auto; max-width: 900px; border-radius: 8px; }
  #panel { max-width: 900px; margin: 0 auto; padding: 1rem; background: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  input { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 6px; }
  button { background: #2980b9; color: #fff; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; margin-top: 0.5rem; }
  #info { font-weight: bold; margin-top: 1rem; }
</style>
</head>
<body>

<header><h1>Ruta desde La Morita (sin API)</h1></header>

<div id="panel">
  <label>Destino:</label>
  <input type="text" id="destino" placeholder="Ej: Plaza Río, Blvd Insurgentes...">
  <button id="btnRuta">Calcular ruta</button>
  <div id="info">Distancia: —</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script>
const origen = [32.4959, -116.8851]; // Calle Jacinto 1126, La Morita
let map = L.map('map').setView(origen, 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

let rutaControl;

// función para buscar dirección en OpenStreetMap
async function geocodificar(direccion) {
  // Si el usuario no pone ciudad o país, los añadimos
  if (!direccion.toLowerCase().includes("tijuana")) {
    direccion += ", Tijuana, Baja California, México";
  }
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}`;
  const res = await fetch(url, { headers: { "Accept-Language": "es" }});
  const data = await res.json();
  if (data.length === 0) throw new Error("No se encontró la dirección");
  return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
}

document.getElementById("btnRuta").addEventListener("click", async () => {
  const destinoTexto = document.getElementById("destino").value.trim();
  if (!destinoTexto) {
    alert("Por favor escribe una dirección destino.");
    return;
  }

  document.getElementById("info").textContent = "Buscando dirección...";
  try {
    const destinoCoord = await geocodificar(destinoTexto);

    if (rutaControl) map.removeControl(rutaControl);

    rutaControl = L.Routing.control({
      waypoints: [L.latLng(origen), L.latLng(destinoCoord)],
      lineOptions: { styles: [{ color: "#2980b9", weight: 5 }] },
      createMarker: () => null,
      router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
      addWaypoints: false,
      routeWhileDragging: false,
      show: false
    }).addTo(map);

    rutaControl.on('routesfound', function(e) {
      const km = e.routes[0].summary.totalDistance / 1000;
      const tiempo = e.routes[0].summary.totalTime / 60;
      document.getElementById("info").textContent = 
        `Distancia: ${km.toFixed(1)} km | Tiempo estimado: ${tiempo.toFixed(0)} min`;
    });

  } catch (err) {
    console.error(err);
    alert("No se encontró la dirección. Intenta escribirla más completa (ej. incluye Tijuana, B.C.)");
    document.getElementById("info").textContent = "Distancia: —";
  }
});
</script>
</body>
</html>
