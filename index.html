<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WebApp de Ventas estilo Didi</title>
<style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; margin: 0; padding: 0; }
    header { background: #2c3e50; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    nav button { background: #2980b9; border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }
    main { padding: 2rem; max-width: 900px; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    th, td { padding: 1rem; border-bottom: 1px solid #ddd; }
    th { background: #2980b9; color: white; }
    td.price, th.price { text-align: right; }
    td.units, th.units { text-align: center; }
    #totalGeneral { font-weight: bold; text-align: right; margin: 1rem 0; }
    form { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.1); margin-bottom: 2rem; }
    label { font-weight: bold; margin-top: 1rem; display: block; }
    input, select, button { width: 100%; padding: 0.6rem; margin-top: 0.5rem; border-radius: 6px; border: 1px solid #ccc; }
    button[type="submit"] { background: #2980b9; color: white; font-weight: bold; border: none; margin-top: 1rem; cursor: pointer; }
</style>
</head>
<body>

<header>
    <h1>WebApp de Ventas</h1>
    <nav>
        <button id="btn-list">Lista</button>
        <button id="btn-catalog">Cat치logo</button>
    </nav>
</header>

<main>
    <!-- P치gina Lista -->
    <section id="page-list" class="active">
        <div id="totalGeneral">Total general: $0.00</div>
        <label for="destino">Direcci칩n de entrega:</label>
        <input type="text" id="destino" placeholder="Ej: Blvd. Insurgentes 1234, Tijuana">
        <button id="btn-calcular-envio">Calcular Env칤o</button>

        <table>
            <thead>
                <tr>
                    <th>Art칤culo</th>
                    <th class="units">Unidades</th>
                    <th>Categor칤a</th>
                    <th class="price">Precio Total</th>
                </tr>
            </thead>
            <tbody id="articulosBody"></tbody>
        </table>
    </section>

    <!-- P치gina Cat치logo -->
    <section id="page-catalog" style="display:none;">
        <form id="formAgregar">
            <h2>Agregar Art칤culo</h2>
            <label>Nombre:</label>
            <input type="text" id="nombreArticulo" required>

            <label>Precio (en $):</label>
            <input type="number" id="precioArticulo" step="0.01" min="0.01" required>

            <label>Tipo:</label>
            <select id="tipoUnidad" required>
                <option value="" disabled selected>Seleccione tipo</option>
                <option value="unidad">Por unidad</option>
                <option value="paquete">Por paquete</option>
            </select>

            <!-- 游 CATEGOR칈A -->
            <label>Categor칤a:</label>
            <select id="categoriaArticulo" required>
                <option value="" disabled selected>Seleccione categor칤a</option>
                <option value="CERVEZA">Cerveza</option>
                <option value="LICOR">Licor</option>
                <option value="COMIDA">Comida</option>
                <option value="OTROS">Otros</option>
            </select>

            <button type="submit">Agregar</button>
        </form>

        <table>
            <thead>
                <tr>
                    <th>Art칤culo</th>
                    <th class="units">Unidades</th>
                    <th>Precio Unidad</th>
                    <th>Tipo</th>
                    <th>Categor칤a</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="catalogBody"></tbody>
        </table>
    </section>
</main>

<script>
(() => {
    // Direcci칩n base (puedes cambiarla si hace falta)
    const baseDireccion = "Calle Jacinto 1126, La Morita, 22245 Tijuana, B.C.";
    const articulosBody = document.getElementById("articulosBody");
    const catalogBody = document.getElementById("catalogBody");
    const totalGeneralElem = document.getElementById("totalGeneral");
    const formAgregar = document.getElementById("formAgregar");
    const nombreInput = document.getElementById("nombreArticulo");
    const precioInput = document.getElementById("precioArticulo");
    const tipoSelect = document.getElementById("tipoUnidad");
    const categoriaSelect = document.getElementById("categoriaArticulo");
    const destinoInput = document.getElementById("destino");

    let articulos = [
        { id: 1, nombre: "6 pack Tecate", unidades: 1, precioUnidad: 100, tipo: "unidad", categoria: "CERVEZA" },
        { id: 2, nombre: "Arroz", unidades: 3, precioUnidad: 10, tipo: "paquete", categoria: "COMIDA" }
    ];
    let proximoId = 3;
    let costoEnvio = 0;

    // --- Actualizaciones de UI ---
    function actualizarLista() {
        articulosBody.innerHTML = "";
        let totalGeneral = 0;

        articulos.forEach(({ nombre, unidades, precioUnidad, tipo, categoria }) => {
            let precioTotal = unidades * precioUnidad;
            if (categoria === "LICOR" || categoria === "CERVEZA") {
                precioTotal *= 1.4; // aplica 40%
            }

            totalGeneral += precioTotal;

            const fila = document.createElement("tr");
            fila.innerHTML = `
                <td>${nombre}</td>
                <td class="units">${unidades}</td>
                <td>${categoria}</td>
                <td class="price">$${precioTotal.toFixed(2)}</td>
            `;
            articulosBody.appendChild(fila);
        });

        totalGeneral += costoEnvio; // incluye env칤o
        totalGeneralElem.textContent = `Total general: $${totalGeneral.toFixed(2)} (incluye env칤o $${costoEnvio.toFixed(2)})`;
    }

    function actualizarCatalogo() {
        catalogBody.innerHTML = "";
        articulos.forEach(({ id, nombre, unidades, precioUnidad, tipo, categoria }) => {
            const fila = document.createElement("tr");
            fila.innerHTML = `
                <td>${nombre}</td>
                <td class="units">${unidades}</td>
                <td>$${precioUnidad.toFixed(2)}</td>
                <td>${tipo}</td>
                <td>${categoria}</td>
                <td><button onclick="eliminarArticulo(${id})">Eliminar</button></td>
            `;
            catalogBody.appendChild(fila);
        });
    }

    // eliminar global
    window.eliminarArticulo = (id) => {
        articulos = articulos.filter(a => a.id !== id);
        actualizarLista();
        actualizarCatalogo();
    };

    formAgregar.addEventListener("submit", (e) => {
        e.preventDefault();
        const nombre = nombreInput.value.trim();
        const precio = parseFloat(precioInput.value);
        const tipo = tipoSelect.value;
        const categoria = categoriaSelect.value;

        if (!nombre || !precio || !tipo || !categoria) {
            alert("Por favor, completa todos los campos.");
            return;
        }

        articulos.push({
            id: proximoId++,
            nombre,
            unidades: 1,
            precioUnidad: precio,
            tipo,
            categoria
        });

        formAgregar.reset();
        actualizarLista();
        actualizarCatalogo();
        document.getElementById("page-catalog").style.display = "none";
        document.getElementById("page-list").style.display = "block";
    });

    // ---------------------------
    // Geocodificaci칩n y distancia
    // ---------------------------

    // Cache para la geocodificaci칩n de la direcci칩n base (evita repetir)
    let cacheBaseCoords = null;

    // Llamada a Nominatim (OpenStreetMap) para obtener lat/lon de una direcci칩n (sin API key)
    async function geocodeNominatim(address) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
        const res = await fetch(url, {
            headers: {
                // Nominatim pide identificar el "User-Agent"/"Referer" idealmente.
                // En navegador no se puede cambiar el User-Agent, pero el Referer ser치 tu dominio.
                'Accept-Language': 'es'
            }
        });
        if (!res.ok) throw new Error("Error en geocoding");
        const json = await res.json();
        if (!json || json.length === 0) throw new Error("No se encontr칩 la direcci칩n");
        // toma el primer resultado
        const { lat, lon } = json[0];
        return { lat: parseFloat(lat), lon: parseFloat(lon) };
    }

    // Haversine: distancia en kil칩metros entre 2 coordenadas
    function haversineKm(a, b) {
        const toRad = v => v * Math.PI / 180;
        const R = 6371; // km radio tierra
        const dLat = toRad(b.lat - a.lat);
        const dLon = toRad(b.lon - a.lon);
        const lat1 = toRad(a.lat);
        const lat2 = toRad(b.lat);

        const sinDLat = Math.sin(dLat/2);
        const sinDLon = Math.sin(dLon/2);
        const aa = sinDLat*sinDLat + sinDLon*sinDLon * Math.cos(lat1) * Math.cos(lat2);
        const c = 2 * Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa));
        return R * c;
    }

    // Calcula distancia (km) entre baseDireccion y destino.
    // Primero intenta geocodificar con Nominatim; si falla, lanza error.
    async function calcularDistancia(origen, destino) {
        try {
            // geocode base (cached)
            if (!cacheBaseCoords) {
                cacheBaseCoords = await geocodeNominatim(origen);
            }
            const destCoords = await geocodeNominatim(destino);
            const km = haversineKm(cacheBaseCoords, destCoords);
            return km;
        } catch (err) {
            // re-lanza para que el llamador maneje el error
            throw err;
        }
    }

    document.getElementById("btn-calcular-envio").addEventListener("click", async () => {
        const destino = destinoInput.value.trim();
        if (!destino) {
            alert("Por favor, ingresa una direcci칩n de destino.");
            return;
        }

        totalGeneralElem.textContent = "Calculando env칤o...";
        try {
            const km = await calcularDistancia(baseDireccion, destino);
            // tarifa por km (puedes ajustar)
            costoEnvio = km * 20;
            actualizarLista();
            alert(`Distancia aproximada: ${km.toFixed(2)} km\nCosto de env칤o: $${costoEnvio.toFixed(2)}`);
        } catch (err) {
            totalGeneralElem.textContent = "Error al calcular distancia.";
            console.error(err);
            alert("No se pudo calcular la distancia. Verifica tu direcci칩n o intenta otra direcci칩n. (" + err.message + ")");
        }
    });

    // Navegaci칩n de p치ginas
    document.getElementById("btn-list").addEventListener("click", () => {
        document.getElementById("page-list").style.display = "block";
        document.getElementById("page-catalog").style.display = "none";
    });
    document.getElementById("btn-catalog").addEventListener("click", () => {
        document.getElementById("page-list").style.display = "none";
        document.getElementById("page-catalog").style.display = "block";
    });

    actualizarLista();
    actualizarCatalogo();
})();
</script>
</body>
</html>
